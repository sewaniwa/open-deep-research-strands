# 要件定義: Open Deep Research を Strands Agents で再現

## 1. プロジェクト概要

### 目的
- LangGraph ベースの Open Deep Research システムを Strands Agents フレームワークで再実装する
- マルチエージェント構成による深層研究システムを構築する

### 現状把握
- **Open Deep Research の特徴**:
  - LangGraph + LangChain ベースのマルチエージェントシステム
  - 4つの専門特化モデル（要約、研究、圧縮、最終レポート）
  - 反復的な研究プロセス
  - Web検索とMCPサーバー統合
  - 設定可能な研究パラメータ

- **Strands Agents の特徴**:
  - プロダクション対応のマルチエージェントシステム
  - モデル非依存のLLMサポート
  - Agent-to-Agent (A2A) 通信
  - スワームとグラフワークフロー
  - AWS エコシステム統合
  - 強力な観測性とセーフティ機能

## 2. 機能要件

### 2.1 コアエージェント構成（Supervisor/制御ループ対応）

#### Supervisorエージェント（Orchestrator）
- **Supervisor Agent**: 研究全体のオーケストレーション
  - 3段階制御ループ（Scope → Research → Report）の管理
  - サブエージェントの動的スパウンと終了判定
  - 研究品質の継続的評価とギャップ分析
  - リソース配分と並行処理の最適化

#### 専門サブエージェント
- **Research Sub-Agents**: 並行実行される特化型研究エージェント
  - 独立したサブトピック研究の実行
  - コンテキスト分離による長文脈問題の回避
  - ツール呼び出しループ（検索、MCP統合）
- **Summarization Agent**: 情報要約処理
- **Compression Agent**: データ圧縮と整理  
- **Report Agent**: 最終レポート生成

#### Strands Agents実装パターン
- **A2A通信**: Supervisor ↔ Sub-Agents間の効率的な情報交換
- **スワーム制御**: 複数Research Sub-Agentsの並行実行管理
- **動的スケーリング**: 研究深度に応じたエージェント数の調整

### 2.2 3段階制御ループ研究プロセス

#### フェーズ1: スコーピング段階
- **ユーザークラリフィケーション**: 研究要求の明確化と対話
- **研究ブリーフ生成**: 包括的で焦点を絞った研究計画の作成
- **サブトピック分解**: 並行研究に適した独立タスクへの分割

#### フェーズ2: 研究段階
- **並行研究実行**: 複数Research Sub-Agentsの同時実行
- **サブトピック研究**: 各エージェントが独立したコンテキストで研究
- **ツール呼び出しループ**: Web検索、MCP統合による情報収集
- **Supervisor反省ループ**: 研究結果の評価とギャップ分析
- **動的再スパウン**: 不足分野への追加エージェント投入

#### フェーズ3: レポート作成段階
- **研究結果統合**: サブエージェント成果の集約
- **品質評価**: 研究ブリーフとの整合性チェック
- **最終レポート生成**: 包括的で構造化された研究成果

#### 制御パラメータ（設定可能）
- **最大研究反復回数** (デフォルト: 3): Supervisorの反省・追加研究回数
- **最大ツール呼び出し回数** (デフォルト: 5): 単一研究ステップでの最大API呼び出し数
- **並行研究エージェント数**: 同時実行するSub-Agentsの数
- **研究深度閾値**: 追加研究の必要性判定基準

### 2.3 外部連携
- Web検索API統合（Google、Bing等）
- MCPサーバー連携（オプション）
- 複数LLMプロバイダーサポート

### 2.4 スコーピング段階ユーザーインターフェース

#### 対話的クラリフィケーション
- **初期クエリ受付**: 自然言語での研究要求入力
- **対話的質問システム**: 研究範囲、深度、制約の明確化
- **コンテキスト収集**: ユーザーの背景知識、目的、期待値の把握
- **要求仕様確認**: 明確化された要件のユーザー承認プロセス

#### インターフェース実装
- **コマンドライン対応**: 
  - 対話型プロンプト
  - 段階的な質問・回答フロー
  - 進捗表示とエージェント状態の可視化
- **Web UI（将来的に）**: 
  - ビジュアルな対話インターフェース
  - リアルタイム研究進捗ダッシュボード
- **設定ファイル**: 
  - 研究パラメータのカスタマイズ
  - エージェント動作設定

## 3. 非機能要件

### 3.1 パフォーマンス
- 並行研究ユニット対応
- 効率的なエージェント間通信
- 適切なレート制限とリソース管理

### 3.2 拡張性
- 新しいエージェントタイプの追加
- カスタム検索ツールの統合
- プラグイン機能

### 3.3 セキュリティ・信頼性・ガードレール

#### セキュリティ要件
- **認証・承認**: Bedrock AgentCore Identity統合
- **データ暗号化**: 保存時・転送時の暗号化
- **API安全性**: レート制限、入力検証、出力サニタイゼーション
- **監査ログ**: 全エージェント活動の詳細記録

#### ガードレール仕様と責任分担

##### 入力レベル（Supervisorエージェント担当）
- **有害コンテンツフィルタ**: 不適切な研究要求の検出・拒否
- **プライバシー保護**: 個人情報、機密情報の識別・マスキング
- **研究範囲制限**: 法的・倫理的に問題のある研究領域の制限
- **リソース制限**: 過度な計算リソース要求の制御

##### 処理レベル（各Sub-Agent担当）
- **情報源検証**: 信頼できる情報源への制限
- **コンテンツフィルタ**: 検索結果からの有害コンテンツ除外
- **バイアス検出**: 偏った情報源や見解の識別・警告
- **ファクトチェック**: 矛盾する情報の識別・検証

##### 出力レベル（Report Agent担当）
- **内容審査**: 最終レポートの適切性確認
- **引用検証**: 情報源の正確性とアクセス可能性確認
- **品質保証**: 誤情報・不完全情報の検出・修正
- **免責事項**: 適切な制限事項と注意書きの付与

#### Bedrock AgentCore活用による強化
- **AgentCore Identity**: 細粒度アクセス制御
- **AgentCore Observability**: リアルタイム異常検知
- **AgentCore Gateway**: ツール使用の監視・制限
- **AgentCore Runtime**: セキュアな実行環境分離

#### 運用手順
- **インシデント対応**: セキュリティ違反時の自動停止・通知
- **定期監査**: ガードレール効果の評価・調整
- **ユーザー教育**: 適切な利用方法の案内・警告表示

## 4. 技術要件

### 4.1 フレームワーク
- **Strands Agents** をベースフレームワークとして使用
- Python 実装
- 非同期処理対応

### 4.2 依存関係
- Strands Agents SDK
- Web検索ライブラリ
- 設定管理ライブラリ
- ロギング/監視ツール

### 4.3 デプロイメント戦略
- **フェーズ1: ローカル開発環境**
  - Python仮想環境での開発
  - Strands Agents SDKを使用した実装
  - ローカルでのテストとデバッグ
  
- **フェーズ2: Bedrock AgentCore クラウド移行**
  - AWS Bedrock AgentCore (2025年7月プレビュー) への移行
  - 7つのAgentCore サービスを活用:
    - **AgentCore Runtime**: セッション分離とマルチモーダル対応
    - **AgentCore Memory**: 短期・長期メモリ管理
    - **AgentCore Gateway**: MCP対応ツール統合
    - **AgentCore Identity**: 認証・アクセス管理
    - **AgentCore Observability**: リアルタイム監視
    - **AgentCore Browser Tool**: Web操作機能
    - **AgentCore Code Interpreter**: セキュアなコード実行環境
  
- **統合アーキテクチャ**
  - Strands Agents + Bedrock AgentCore の完全統合
  - MCPプロトコルとA2A通信サポート
  - スケーラブルなマルチエージェントデプロイメント

## 5. 定量的成功基準と評価フレームワーク

### 5.1 多次元評価システム（0-1スケール）

#### 研究品質評価指標
- **正確性 (Accuracy)**: 事実の正確性と情報源の信頼性
  - 目標: 0.85以上（Open Deep Research ベースライン対比）
- **深度 (Depth)**: 分析の深さと包括性
  - 目標: 0.80以上
- **情報源品質 (Source Quality)**: 引用された情報源の権威性と関連性
  - 目標: 0.90以上
- **推論明確性 (Reasoning Clarity)**: 論理的な一貫性と説明の明確さ
  - 目標: 0.85以上
- **完全性 (Completeness)**: 研究ブリーフに対する網羅性
  - 目標: 0.80以上

#### システム性能評価指標
- **応答時間**: 初期クエリから最終レポートまでの処理時間
  - 目標: 平均5分以内（中規模クエリ）
- **並行効率**: 複数Sub-Agentsの同時実行効果
  - 目標: 単一エージェント比50%の時間短縮
- **リソース使用効率**: CPU/メモリ使用量の最適化
  - 目標: Bedrock AgentCore制限内での安定動作

### 5.2 バッチ評価システム

#### 評価データセット
- **ベースラインデータセット**: 既存Open Deep Researchでの同一クエリ結果
- **標準テストケース**: 複数の研究分野にわたるクエリ集合
- **比較評価**: LangSmithデータセットとの整合性確認

#### 自動評価プロセス
- **評価スクリプト**: `tests/run_evaluate.py` 相当の実装
- **専門評価器**: `tests/evaluators.py` 形式の多次元スコアリング
- **継続的監視**: 本番環境での品質劣化検知

### 5.3 段階別成功基準

#### 機能的成功基準
- [ ] Supervisorエージェントによる3段階制御ループの完全実装
- [ ] 並行Research Sub-Agentsの動的スパウン・管理
- [ ] スコーピング段階での効果的なユーザー対話
- [ ] ギャップ分析による自動的な追加研究実行
- [ ] 研究ブリーフとの整合性を保った最終レポート生成

#### 品質基準（定量的）
- [ ] 全評価指標で目標値以上のスコア達成
- [ ] ベースライン（元Open Deep Research）対比同等以上の性能
- [ ] バッチ評価での一貫した高品質結果
- [ ] ユーザー満足度調査での高評価（将来的）

#### 技術的成功基準
- [ ] Strands Agents A2A通信の効率的な実装
- [ ] Bedrock AgentCoreサービスの段階的統合完了
- [ ] スケーラブルなマルチエージェント実行環境
- [ ] 包括的な観測性とログ機能
- [ ] 自動テストカバレッジ80%以上

## 6. 制約事項

### 6.1 技術的制約
- Strands Agentsフレームワークの機能範囲内での実装
- 外部API（検索、LLM）のレート制限
- メモリとCPUリソースの効率的な使用

### 6.2 運用制約
- APIキーと認証情報の安全な管理
- コスト管理（LLM API + Bedrock AgentCore 使用料）
  - 2025年9月16日まで無料（プレビュー期間）
  - 従量課金制: Runtime ($0.0895/vCPU-hour), Memory ($0.25/1,000イベント), Gateway ($0.005/1,000 API呼び出し)
- データプライバシーとセキュリティ
- Bedrock AgentCore対応リージョン制限 (US East, US West, Asia Pacific Sydney, Europe Frankfurt)

## 7. リスクと対策

### 7.1 技術的リスク
- **リスク**: Strands AgentsがLangGraphの機能を完全にカバーできない
- **対策**: 早期のプロトタイプで機能確認、必要に応じて設計調整

### 7.2 外部依存リスク
- **リスク**: 検索APIの利用制限や変更
- **対策**: 複数検索プロバイダーの対応、フォールバック機能

### 7.3 品質リスク
- **リスク**: 研究品質の低下
- **対策**: 評価システムの実装、継続的な品質監視

## 8. デプロイメント段階別仕様

### 8.1 フェーズ1: ローカル開発環境
- Strands Agents SDK使用
- ローカルLLMまたはクラウドAPI接続
- 基本的なWeb検索統合
- 簡単なファイルベース設定

### 8.2 フェーズ2: Bedrock AgentCore 統合
- AgentCore Runtime での実行環境移行
- AgentCore Memory によるセッション管理強化
- AgentCore Gateway での高度なツール統合
- AgentCore Observability による本格監視
- 企業レベルのセキュリティとスケーラビリティ

### 8.3 移行戦略
- ローカル環境で完全テスト後にクラウド移行
- Bedrock AgentCore の各サービスを段階的に導入
- パフォーマンス最適化とコスト管理の実装

## 9. 次のステップ

設計フェーズでは以下を詳細化する：
- Strands Agentsでのマルチエージェント設計
- エージェント間通信プロトコル
- ワークフローの具体的実装方法
- Bedrock AgentCore統合アーキテクチャ
- ローカル→クラウド移行手順